#!/bin/sh
# OpenWrt 一键插件安装（断点续装 + 确认提示版）

#================= 可修改区域 =================
# 用空格分隔，避免多行反斜杠带来的解析问题
PLUGINS="luci-theme-argon openssh-sftp-server luci-i18n-diskman-zh-cn luci-i18n-homeproxy-zh-cn luci-i18n-ddns-go-zh-cn luci-i18n-dockerman-zh-cn"
RETRY_MAX=3             # 安装失败时重试次数
RETRY_SLEEP_BASE=3      # 每次重试的基础等待秒数（指数回退）
#=============================================

LOG_DIR="/root"
TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="$LOG_DIR/opkg_install_${TS}.log"

log() {
  printf '%s %s\n' "$(date '+%F %T')" "$*" | tee -a "$LOG_FILE"
}

is_installed() {
  opkg status "$1" 2>/dev/null | grep -q "^Status: .* installed"
}

opkg_update_once() {
  FLAG="/tmp/.opkg_updated_once"
  if [ -f "$FLAG" ]; then
    log "已在本次会话中执行过 opkg update，跳过。"
    return 0
  fi

  n=1
  while [ $n -le $RETRY_MAX ]; do
    log "执行软件源更新：opkg update (第 $n/$RETRY_MAX 次)"
    if opkg update >>"$LOG_FILE" 2>&1; then
      touch "$FLAG"
      log "opkg update 成功。"
      return 0
    fi
    SLEEP=$((RETRY_SLEEP_BASE ** n))
    log "opkg update 失败，$SLEEP 秒后重试…"
    sleep "$SLEEP"
    n=$((n+1))
  done

  log "opkg update 多次失败，请检查网络或软件源。"
  return 1
}

install_pkg_with_retry() {
  PKG="$1"
  n=1
  while [ $n -le $RETRY_MAX ]; do
    log "安装 $PKG (第 $n/$RETRY_MAX 次)…"
    if opkg install "$PKG" >>"$LOG_FILE" 2>&1; then
      log "安装成功：$PKG"
      return 0
    fi
    SLEEP=$((RETRY_SLEEP_BASE ** n))
    log "安装失败：$PKG，$SLEEP 秒后重试…"
    sleep "$SLEEP"
    n=$((n+1))
  done
  return 1
}

list_pending() {
  PENDING=""
  for pkg in $PLUGINS; do
    if ! is_installed "$pkg"; then
      PENDING="$PENDING $pkg"
    fi
  done
  # 去掉开头空格
  echo "$PENDING" | sed 's/^ *//'
}

main() {
  [ "$(id -u)" -ne 0 ] && { echo "请用 root 运行。"; exit 1; }

  PENDING="$(list_pending)"

  echo "==========================================="
  echo "OpenWrt 插件一键安装"
  echo "日志文件：$LOG_FILE"
  echo "==========================================="

  if [ -z "$PENDING" ]; then
    echo "检测到所有目标插件均已安装，无需继续。"
    exit 0
  fi

  echo "即将安装以下未安装的插件："
  for p in $PENDING; do
    echo "  - $p"
  done
  printf "是否继续？（回车继续，N退出）："
  read ans
  case "$ans" in
    N|n)
      echo "已取消。"
      exit 0
      ;;
    *)
      echo "继续执行安装..."
      ;;
  esac

  log "==== OpenWrt 插件一键安装开始 ===="
  log "待安装：$PENDING"
  log "日志文件：$LOG_FILE"

  if ! opkg_update_once; then
    log "由于 opkg update 失败，终止安装。"
    exit 1
  fi

  FAILED=""
  SKIPPED=""
  DONE=""

  for pkg in $PENDING; do
    if is_installed "$pkg"; then
      log "已安装，跳过：$pkg"
      SKIPPED="$SKIPPED $pkg"
      continue
    fi

    if install_pkg_with_retry "$pkg"; then
      DONE="$DONE $pkg"
    else
      log "多次失败，放弃：$pkg"
      FAILED="$FAILED $pkg"
    fi
  done

  echo >>"$LOG_FILE"
  log "==== 安装结果汇总 ===="
  [ -n "$DONE" ]    && log "成功安装：$DONE"
  [ -n "$SKIPPED" ] && log "已存在(跳过)：$SKIPPED"
  if [ -n "$FAILED" ]; then
    log "安装失败：$FAILED"
    log "可稍后再次运行脚本自动续装，或查看日志排查：$LOG_FILE"
    exit 2
  else
    log "全部处理完成，无失败项。"
    exit 0
  fi
}

main "$@"
