#!/bin/sh
# OpenWrt 一键插件安装（断点续装 + 确认提示版）

#================= 可修改区域 =================
# 用空格分隔，避免多行反斜杠带来的解析问题
PLUGINS="luci-theme-argon openssh-sftp-server luci-i18n-diskman-zh-cn luci-i18n-homeproxy-zh-cn luci-i18n-ddns-go-zh-cn luci-i18n-dockerman-zh-cn"
RETRY_MAX=3             # 安装失败时重试次数
RETRY_SLEEP_BASE=3      # 每次重试的基础等待秒数（指数回退）
#=============================================

LOG_DIR="/root"
TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="$LOG_DIR/opkg_install_${TS}.log"

log() {
  printf '%s %s\n' "$(date '+%F %T')" "$*" | tee -a "$LOG_FILE"
}

is_installed() {
  opkg status "$1" 2>/dev/null | grep -q "^Status: .* installed"
}

opkg_update_once() {
  FLAG="/tmp/.opkg_updated_once"
  if [ -f "$FLAG" ]; then
    log "已在本次会话中执行过 opkg update，跳过。"
    return 0
  fi

  n=1
  while [ $n -le $RETRY_MAX ]; do
    log "执行软件源更新：opkg update (第 $n/$RETRY_MAX 次)"
    if opkg update >>"$LOG_FILE" 2>&1; then
      touch "$FLAG"
      log "opkg update 成功。"
      return 0
    fi
    SLEEP=$((RETRY_SLEEP_BASE ** n))
    log "opkg update 失败，$SLEEP 秒后重试…"
    sleep "$SLEEP"
    n=$((n+1))
  done

  log "opkg update 多次失败，请检查网络或软件源。"
  return 1
}

install_pkg_with_retry() {
  PKG="$1"
  n=1
  while [ $n -le $RETRY_MAX ]; do
    log "安装 $PKG (第 $n/$RETRY_MAX 次)…"
    if o
